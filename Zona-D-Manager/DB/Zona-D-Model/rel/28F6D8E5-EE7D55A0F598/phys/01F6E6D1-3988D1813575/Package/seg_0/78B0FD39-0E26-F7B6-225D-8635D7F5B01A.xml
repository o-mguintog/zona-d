<?xml version = '1.0' encoding = 'UTF-8'?>
<PackageOracle class="oracle.dbtools.crest.model.design.storage.oracle.PackageOracle" name="ZONA_D_PROCESS_PKG" directorySegmentName="seg_0" id="78B0FD39-0E26-F7B6-225D-8635D7F5B01A">
<createdBy>Zona-D</createdBy>
<createdTime>2024-12-14 06:27:03 UTC</createdTime>
<ownerDesignName>Zona-D-Model</ownerDesignName>
<owner><![CDATA[0E301316-E54A-04D8-3D02-7738C7E3DEAE]]></owner>
<source>create or replace NONEDITIONABLE PACKAGE &quot;Zona-D&quot;.ZONA_D_PROCESS_PKG AS 
    
    /**
     * Procesa las fichas nuevas 
    **/
    PROCEDURE ACTIVE_NEW_FICHAS_PS(PIC_FICHAS VARCHAR2);

    PROCEDURE DISABLED_FICHAS_PS(PIC_FICHAS VARCHAR2);

    PROCEDURE REGISTER_FICHAS_PS(PIC_FICHAS VARCHAR2);

END ZONA_D_PROCESS_PKG;</source>
<body class="oracle.dbtools.crest.model.design.storage.oracle.PackageBodyOracle" name="ZONA_D_PROCESS_PKG" id="78B0FD39-0E26-F7B6-225D-8635D7F5B01A">
<createdBy>Zona-D</createdBy>
<createdTime>2024-12-14 06:27:30 UTC</createdTime>
<ownerDesignName>Zona-D-Model</ownerDesignName>
<owner><![CDATA[0E301316-E54A-04D8-3D02-7738C7E3DEAE]]></owner>
<source>create or replace NONEDITIONABLE PACKAGE BODY &quot;Zona-D&quot;.ZONA_D_PROCESS_PKG AS
    
    
    
    FUNCTION GET_FICHA_END_DATE(PIC_FICHA VARCHAR2)RETURN DATE 
    AS
        L_END_DATE DATE;
    BEGIN

        BEGIN
            SELECT SYSDATE + Profiles.PROFILE_TIME END_DATE
            INTO L_END_DATE
            FROM ZD_FICHAS Fichas,
                 ZD_PROFILES Profiles
            WHERE 1 = 1
              AND Fichas.NAME  = PIC_FICHA
              AND Profiles.CODE_PROFILE = Fichas.PROFILE;
        EXCEPTION 
            WHEN NO_DATA_FOUND THEN
                L_END_DATE := NULL;
                dbms_output.put_line(&apos;error&apos;);
            WHEN OTHERS THEN 
                dbms_output.put_line(&apos;error&apos;);
        END;


    RETURN L_END_DATE;

    END;

    PROCEDURE ACTIVE_NEW_FICHAS_PS(PIC_FICHAS VARCHAR2) AS
        PRAGMA AUTONOMOUS_TRANSACTION;

        cursor cur_fichas_new_cur is
            select Ficha,
                      Status
                from json_table(PIC_FICHAS,&apos;$.responseFichas[*]&apos;
                                columns (ficha varchar2(100) path &apos;$.ficha&apos; ,
                                         status varchar2(100) path &apos;$.status&apos; ))
            WHERE Status =&apos;ACTIVE&apos;;

            L_END_DATE DATE;
    BEGIN

        FOR cur_fichas_new_rec IN cur_fichas_new_cur
        LOOP

            --Obtiene la fecha fin

            L_END_DATE := GET_FICHA_END_DATE(cur_fichas_new_rec.Ficha);        

            --Actualiza la activación
            UPDATE ZD_FICHAS FichasOld
                SET FichasOld.STATUS = cur_fichas_new_rec.status,
                    FichasOld.begin_date = sysdate,
                    FichasOld.end_date = L_END_DATE
            WHERE 1 = 1
              AND FichasOld.NAME = cur_fichas_new_rec.FICHA;

        END LOOP;

        COMMIT;

    END ACTIVE_NEW_FICHAS_PS;


    PROCEDURE DISABLED_FICHAS_PS(PIC_FICHAS VARCHAR2) AS
        PRAGMA AUTONOMOUS_TRANSACTION;

    cursor cur_fichas_new_cur is
        select Ficha,
                  Status
            from json_table(PIC_FICHAS,&apos;$.responseFichas[*]&apos;
                            columns (ficha varchar2(100) path &apos;$.ficha&apos; ,
                                     status varchar2(100) path &apos;$.status&apos; ))
        WHERE Status =&apos;FINISHED&apos;;

    BEGIN

        FOR cur_fichas_new_rec IN cur_fichas_new_cur
        LOOP

            --Actualiza la activación
            UPDATE ZD_FICHAS FichasOld
                SET FichasOld.STATUS = cur_fichas_new_rec.status                
            WHERE 1 = 1
              AND FichasOld.NAME = cur_fichas_new_rec.FICHA;

        END LOOP;

        COMMIT;

    END;

    PROCEDURE REGISTER_FICHAS_PS(PIC_FICHAS VARCHAR2)AS

        PRAGMA AUTONOMOUS_TRANSACTION;

        CURSOR NEW_FICHAS_CUR IS
            select title,
                   profile,
                   vendor,
                   username1,
                   username2,
                   username3,
                   username4,
                   username5,
                   username6,
                   username7,
                   username8,
                   username9,
                   username10,
                   username11,
                   username12

                from json_table(PIC_FICHAS,&apos;$[*]&apos;
                columns (title varchar2(100) path &apos;$.title&apos; ,
                         profile varchar2(100) path &apos;$.profileCode&apos;,

                         vendor varchar2(100) path &apos;$.vendor&apos;,
                         username1 varchar2(100) path &apos;$.username1&apos;,
                         username2 varchar2(100) path &apos;$.username2&apos;,
                         username3 varchar2(100) path &apos;$.username3&apos;,
                         username4 varchar2(100) path &apos;$.username4&apos;,
                         username5 varchar2(100) path &apos;$.username5&apos;,
                         username6 varchar2(100) path &apos;$.username6&apos;,
                         username7 varchar2(100) path &apos;$.username7&apos;,
                         username8 varchar2(100) path &apos;$.username8&apos;,
                         username9 varchar2(100) path &apos;$.username9&apos;,
                         username10 varchar2(100) path &apos;$.username10&apos;,
                         username11 varchar2(100) path &apos;$.username11&apos;,
                         username12 varchar2(100) path &apos;$.username12&apos;));



    BEGIN

        BEGIN
            --Itera sobre la plantilla de usuarios
            FOR NEW_FICHAS_REC IN NEW_FICHAS_CUR LOOP

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME1,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME2,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME3,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME4,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME5,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME6,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME7,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME8,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME9,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);                                                      

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME10,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);    

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME11,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);                                                      

                INSERT INTO ZD_FICHAS (NAME,PROFILE,VENDOR_ID) VALUES(NEW_FICHAS_REC.USERNAME12,
                                                                      NEW_FICHAS_REC.PROFILE,
                                                                      NEW_FICHAS_REC.VENDOR);                                                                       
            END LOOP;

            COMMIT;
        EXCEPTION WHEN OTHERS THEN
            dbms_output.put_line(&apos;Error&apos;||SQLCODE||&apos; -ERROR- &apos;||SQLERRM);
        END;
    END;

END ZONA_D_PROCESS_PKG;</source>
</body>
</PackageOracle>
